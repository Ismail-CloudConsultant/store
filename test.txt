import pandas as pd
import numpy as np
from pandas.tseries.offsets import MonthEnd

# Assuming your dataframe is named:
# df = pd.read_csv(...) or pd.read_gbq(...) etc.

# 1. Filter for n_mob1 in (1, 3)
df_filtered = df[df['n_mob1'].isin([1, 3])].copy()

# 2. Trim Source_File and rename to Country
df_filtered['Country'] = df_filtered['Source_File'].astype(str).str.strip()

# 3. Convert acq_mon to a proper date ending on the last day of the month
df_filtered['acq_mon'] = pd.to_datetime(df_filtered['acq_mon'].astype(str) + '28', format='%Y%m%d') + MonthEnd(0)

# 4. Group and aggregate
df_grouped = (
    df_filtered
    .groupby(['Country', 'n_mob1', 'm_mon', 'acq_mon'], dropna=False)
    .agg(
        Total_Accnt=('accts', 'sum'),
        Ever_Activation=('ever_activation_flag', lambda x: np.nansum(pd.to_numeric(x, errors='coerce'))),
        Ever_Debit_Active=('ever_debit_active', lambda x: np.nansum(pd.to_numeric(x, errors='coerce')))
    )
    .reset_index()
)