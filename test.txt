import pandas as pd

# Step 1: Clean and prepare
df = df.copy()
df['Country'] = df['Country'].str.strip()
df['Finance_Data_USD'] = df['Finance_Data_USD'].str.strip()
df['Date'] = pd.to_datetime(df['Date'], errors='coerce')
df['Value'] = pd.to_numeric(df['Value'], errors='coerce')

# Step 2: Filter for relevant metrics
metrics_filter = ['Rewards Expense ($m)', 'Spend ($m)']
df = df[df['Finance_Data_USD'].isin(metrics_filter)]

# Step 3: Group and sum values
grouped = df.groupby(['Country', 'Date', 'Finance_Data_USD'])['Value'].sum().reset_index()

# Step 4: Pivot to wide format
pivot_df = grouped.pivot_table(
    index=['Country', 'Date'],
    columns='Finance_Data_USD',
    values='Value',
    fill_value=0
).reset_index()

# Step 5: Rename columns to match SQL output
pivot_df = pivot_df.rename(columns={
    'Rewards Expense ($m)': 'Rewards_Expense_USDm',
    'Spend ($m)': 'Spend_USDm'
})

# Step 6: Map COUNTRY1 codes
country_map = {
    "US (adjusted)": "USA",
    "Canada (adjusted)": "CAN",
    "Vietnam": "VNM",
    "UK (adjusted ex JLFS)": "UK",
    "UK (excl. JLFS)": "UK",
    "Taiwan": "TWN",
    "Singapore": "SGH",
    "Mexico": "MEX",
    "Malaysia": "MYH",
    "India": "INM",
    "Egypt": "EGY",
    "China": "AOC",
    "Australia": "AUH",
    "UAE": "UAE",
    "HASE": "HASE",
    "AMH": "AMH",
    "Indonesia": "IMO",
    "Philippines": "MNL"
}
pivot_df['COUNTRY1'] = pivot_df['Country'].map(country_map)

# Step 7: Filter for desired COUNTRY1 values only
valid_country1 = ['UK','AMH','HASE','MEX','UAE','SGH','MYH','INM','VNM','TWN','EGY','CAN','USA','AUH','AOC', 'IMO', 'MNL']
filtered_df = pivot_df[pivot_df['COUNTRY1'].isin(valid_country1)]

# Step 8: Final column order and sorting
final_df = filtered_df[[
    'COUNTRY1', 'Country', 'Date', 'Rewards_Expense_USDm', 'Spend_USDm'
]].sort_values(by=['Country', 'Date'])