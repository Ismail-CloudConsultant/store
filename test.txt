import pandas as pd
from pandas.tseries.offsets import MonthEnd

# Step 1: Filter for required metrics
valid_metrics = [
    "All CASA & TD NTB Premier Customers",
    "Card holding for all CASA & TD NTB Premier Customers",
    "All CASA & TD NTB Non-Premier Customers",
    "Card holding for all CASA & TD NTB Non-premier Customers"
]
df = df[df['Metric'].isin(valid_metrics)]

# Step 2: Map Metric to simplified METRIC codes
metric_map = {
    "All CASA & TD NTB Premier Customers": "ALL_PREM",
    "Card holding for all CASA & TD NTB Premier Customers": "ALL_PREM_WITH_CARD",
    "All CASA & TD NTB Non-Premier Customers": "ALL_NPREM",
    "Card holding for all CASA & TD NTB Non-premier Customers": "ALL_NPREM_WITH_CARD"
}
df['METRIC'] = df['Metric'].map(metric_map)

# Step 3: Convert date to month-end
df['Date'] = pd.to_datetime(df['month'], errors='coerce') + MonthEnd(0)

# Step 4: Convert Value to float
df['Value'] = pd.to_numeric(df['Value'], errors='coerce')

# Step 5: Add constant column
df['Cust_Type'] = 'NTB'

# Step 6: Pivot the data
pivot_df = df.pivot_table(
    index=['Country', 'Date', 'MOB', 'Cust_Type'],
    columns='METRIC',
    values='Value',
    aggfunc='sum',
    fill_value=0
).reset_index()

# Step 7: Clean up column names
pivot_df.columns.name = None  # Remove column group name from pivot