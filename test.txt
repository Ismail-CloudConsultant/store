import pandas as pd
import numpy as np

# Step 1: Filter relevant metrics
valid_metrics = [
    "Premier Customers (excluding card only)",
    "Non-Premier Customers (excluding card only)"
]
df = df[df['Metrics'].isin(valid_metrics)]

# Step 2: Map to METRIC column
metric_map = {
    ("WPB", "Premier Customers (excluding card only)"): "PremCustomers",
    ("Cards", "Premier Customers (excluding card only)"): "PremCustomerCards",
    ("WPB", "Non-Premier Customers (excluding card only)"): "NonPremCustomers",
    ("Cards", "Non-Premier Customers (excluding card only)"): "NonPremCustomerCards"
}
df['METRIC'] = df.apply(lambda row: metric_map.get((row['Product'], row['Metrics'])), axis=1)

# Step 3: Convert Value to float
df['Value'] = pd.to_numeric(df['Value'], errors='coerce')

# Step 4: Pivot data
pivot_df = df.pivot_table(
    index=['Country', 'Date'],
    columns='METRIC',
    values='Value',
    aggfunc='sum',
    fill_value=0
).reset_index()

# Step 5: Calculate penetration metrics
pivot_df['Prem_Pen'] = np.where(
    pivot_df['PremCustomers'] != 0,
    pivot_df['PremCustomerCards'] / pivot_df['PremCustomers'],
    0
)

pivot_df['NonPrem_Pen'] = np.where(
    pivot_df['NonPremCustomers'] != 0,
    pivot_df['NonPremCustomerCards'] / pivot_df['NonPremCustomers'],
    0
)

# Step 6: Add Cust_Type column
pivot_df['Cust_Type'] = 'ETB'

# Optional: Clean column names
pivot_df.columns.name = None