# 8️⃣ Margin Impact Analysis
if 'Margin Rate' in df.columns:
    # Scatter: Margin vs Amount
    fig = px.scatter(df, x='Margin Rate', y=amount_col, 
                     color='Product', 
                     hover_data=['Currency Pair', 'Channel', 'Segment'],
                     title='Impact of Margin Rate on Transaction Amount')
    fig.write_html(f"{outdir}/margin_vs_amount.html")

    # Scatter: Margin vs No. of Transactions
    fig = px.scatter(df, x='Margin Rate', y=txn_col,
                     color='Product',
                     hover_data=['Currency Pair', 'Channel', 'Segment'],
                     title='Impact of Margin Rate on Number of Transactions')
    fig.write_html(f"{outdir}/margin_vs_transactions.html")

    # Aggregated impact per margin bucket
    df['Margin Bucket'] = pd.cut(df['Margin Rate'],
                                 bins=[0, 0.0085, 0.0095, 0.0115, 0.0185], 
                                 labels=['Low', 'Medium', 'High', 'Very High'])
    margin_summary = df.groupby('Margin Bucket').agg(
        total_value=(amount_col, 'sum'),
        total_count=(txn_col, 'sum'),
        avg_amount=(amount_col, 'mean')
    ).reset_index()

    margin_summary.to_csv(f"{outdir}/margin_bucket_summary.csv", index=False)

    fig = px.bar(margin_summary, x='Margin Bucket', y='total_value',
                 title='Total Transaction Value by Margin Bucket')
    fig.write_html(f"{outdir}/margin_bucket_value.html')

    fig = px.bar(margin_summary, x='Margin Bucket', y='total_count',
                 title='Total Transactions by Margin Bucket')
    fig.write_html(f"{outdir}/margin_bucket_count.html')