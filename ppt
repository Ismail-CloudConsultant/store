import re
import pandas as pd
import streamlit as st

# ---------------- Instruction Parser ----------------
def parse_instruction(text):
    # Extract currency pairs (AUD-NZD, USD-EUR, etc.)
    currency_pairs = re.findall(r"[A-Z]{3}[- ]?[A-Z]{3}", text)

    # Extract percentage or bps
    change = None
    percent_match = re.findall(r"(\d+)\s*%", text)
    bps_match = re.findall(r"(\d+)\s*bps", text, flags=re.IGNORECASE)

    if percent_match:
        change = f"{percent_match[0]}%"
    elif bps_match:
        change = f"{bps_match[0]} bps"

    # Detect action (increase/decrease)
    if re.search(r"increase|raise", text, re.IGNORECASE):
        action = "Increase"
    elif re.search(r"decrease|reduce", text, re.IGNORECASE):
        action = "Decrease"
    else:
        action = None

    # Detect customer segment
    customer_type = None
    match = re.search(r"(Premier|Retail|Corporate|Personal)", text, re.IGNORECASE)
    if match:
        customer_type = match.group(1).capitalize()

    # Detect tier/bucket
    tier_bucket = None
    match = re.search(r"(tier\s*\d+\s*bucket)", text, re.IGNORECASE)
    if match:
        tier_bucket = match.group(1).title()  # e.g., "Tier 2 Bucket"

    return {
        "Sentence": text.strip(),
        "Currency Pair": currency_pairs[0] if currency_pairs else None,
        "Action": action,
        "Change": change,
        "Customer Segment": customer_type,
        "Tier/Bucket": tier_bucket
    }

def create_grid(paragraph):
    lines = [line.strip() for line in paragraph.split("\n") if line.strip()]
    parsed_data = [parse_instruction(line) for line in lines]
    df = pd.DataFrame(parsed_data)
    return df


# ---------------- New Instruction Parser Sheet ----------------
elif sheet == "Instruction Parser":
    st.header("üí¨ Instruction Parser")

    st.write("Paste instructions below (one per line). Example:")
    st.code("""Can you increase the currency margin of AUD-NZY by 10 bps for all Premier Customers for tier 2 bucket.
Please decrease the currency margin of USD-EUR by 5 bps for Retail Customers tier 5 bucket.""")

    instructions = st.text_area("Enter Instructions:", height=200)

    if st.button("Generate Grid"):
        if instructions.strip():
            grid = create_grid(instructions)
            st.success("‚úÖ Instructions parsed successfully!")
            st.dataframe(grid, use_container_width=True)

            # Optional: Download grid
            csv = grid.to_csv(index=False).encode("utf-8")
            st.download_button(
                label="üì• Download Grid as CSV",
                data=csv,
                file_name="instruction_grid.csv",
                mime="text/csv"
            )
        else:
            st.warning("‚ö†Ô∏è Please enter at least one instruction.")
